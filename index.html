<!DOCTYPE html>
<html>
	<style>
	</style>
	<head>
		<title>Card generator</title>
		<meta charset="UTF-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	</head>
	<body>
		<form id="form-main">
			<label for="card-name">Card name</label>
			<input type="text" id="card-name">
			<br/>
			<label for="limited">Limited</label>
			<input type="radio" name="limited" value="yes"> yes
			<input type="radio" name="limited" value="no" checked> no
			<br/>
			<label for="card-type">Card type</label>
			<select name="card-type">
				<option value="ept" selected>EPT</option>
				<option value="force">Force</option>
				<option value="astromech">Astromech</option>
				<option value="torpedoes">Torpedoes</option>
				<option value="missiles">Missiles</option>
				<option value="cannon">Cannon</option>
				<option value="turret">Turret</option>
				<option value="device">Device</option>
				<option value="crew">Crew</option>
				<option value="gunner">Gunner</option>
				<option value="system">System</option>
				<option value="illicit">Illicit</option>
				<option value="title">Title</option>
				<option value="modification">Modification</option>
			</select>
			<br/>
			<label for="slots-numbers">Slots</label>
			<input type="radio" name="lots-numbers" value="1" checked> 1
			<input type="radio" name="lots-numbers" value="2"> 2
			<br/>
			<label for="card-image">Card image</label>
			<input name="card-image" id="card-image" type="file"/>
			<hr/>
			<div id="secondary-weapon-stats" hidden>
				<label for="require">Required</label>
				<input type="radio" name="require" value="nothing" checked> nothing
				<input type="radio" name="require" value="target-lock"> targe lock
				<input type="radio" name="require" value="focus"> focus
				<br/>
				<label for="dice-number">Dices</label>
				<input type="range" id="dice-number" name="min-range" min="1" max="9" value="3"/>
				<span id="dice-number-visualizer"></span>
				<br/>
				<label for="range-bonus">Range bonus</label>
				<input type="radio" name="range-bonus" value="yes" checked> yes
				<input type="radio" name="range-bonus" value="no"> no
				<br/>
				<label for="arc-type">Firing arc type</label>
				<input type="radio" name="arc-type" value="classic" checked> classic
				<input type="radio" name="arc-type" value="bullseye"> bullseye
				<input type="radio" name="arc-type" value="single-rotating"> single rotating
				<input type="radio" name="arc-type" value="double-rotating"> double rotating
				<br/>
				<label for="min-range">Minimum range</label>
				<input type="range" id="min-range" name="min-range" min="1" max="5" value="1"/>
				<span id="min-range-visualizer"></span>
				<br/>
				<label for="max-range">Maximum range</label>
				<input type="range" id="max-range" name="max-range" min="1" max="5" value="3"/>
				<span id="max-range-visualizer"></span>
				<hr/>
			</div>
			<label for="charge-number">Charges</label>
			<input type="range" id="charge-number" name="charge-number" min="0" max="9" value="0"/>
			<span id="charge-number-visualizer"></span>
			<br/>
			<label for="charge-regenerate">Regenerate</label>
			<input type="radio" name="charge-regenerate" value="yes"> yes
			<input type="radio" name="charge-regenerate" value="no" checked> no
			<hr/>
			<!--
				!bo			boost
				!ch			charge
				!cr			critical hit
				!ev			evade
				!fo			focus
				!hi			hit
				!re			reinforce
				!tl			target lock
			-->
			<label for="card-text">Card text</label>
			<textarea rows="4" cols="50" name="card-text"></textarea>
			<p>!bo (boost), !ch (charge), !cr (critical hit), !ev (evade), !fo (focus), !hi (hit), !re (reinforce), !tl (target lock)</p>
			<hr/>
			Restrictions
			<hr/>
			<input type="submit" value="Create">
		</form>

		<br/>

		<div id="outputImageContainer">
			<img src="">
			<br/>
			<a download="" href="">
		</div>

		<script>
			var form = $("form#form-main");
			var cardgenOutput;
			var logOutput = false;

			$(document).ready(function(){
				$('input[type=range]#dice-number').trigger('change');
				$('input[type=range]#min-range').trigger('change');
				$('input[type=range]#max-range').trigger('change');
				$('input[type=range]#charge-number').trigger('change');
			});

			$('select[name=card-type]').change(function(e){

				var cardType = $('select[name=card-type] option:selected').val();

				$('form#form-main input').prop('disabled', false);

				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){
					$('div#secondary-weapon-stats').show();

					if(cardType == 'torpedoes' || cardType == 'missiles'){
						$('form#form-main input[name=charge-regenerate][value=yes]').prop('disabled', true);
						$('form#form-main input[name=charge-regenerate][value=no]').prop('checked', true);
					}
	
					var selectedArc = $('form#form-main input[name=arc-type]:checked').val();

					if(cardType == 'turret'){
						$('form#form-main input[name=arc-type][value=classic]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=bullseye]').prop('disabled', true);
						if(selectedArc == 'classic' || selectedArc == 'bullseye'){
							$('form#form-main input[name=arc-type][value=single-rotating]').prop('checked', true);
						}
					}else{
						$('form#form-main input[name=arc-type][value=single-rotating]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=double-rotating]').prop('disabled', true);
						if(selectedArc == 'single-rotating' || selectedArc == 'double-rotating'){
							$('form#form-main input[name=arc-type][value=classic]').prop('checked', true);
						}
					}

				}else{
					$('div#secondary-weapon-stats').hide();

					$('form#form-main input[name=card-text_size][value=large').prop('disabled', false);
				}
			});

			$('select[name=card-type], form#form-main input[name=require], form#form-main input[type=range]#charge-number').change(function(e){
				var cardType = $('select[name=card-type] option:selected').val();
				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){
					var oldText = $('textarea[name=card-text]').html();
					var text = '';
					var require = $('form#form-main input[name=require]:checked').val();
					var charges = $('form#form-main input[type=range]#charge-number').val()

					text += 'Attack';
					if(require != 'nothing'){
						if(require == 'target-lock'){
							text += ' (!tl)';
						}else{
							text += ' (!fo)';
						}
					}
					text += ': ';

					if(charges != '0'){
						text += 'Spend 1 !ch.'
					}

					$('textarea[name=card-text]').val(text);
				}
			});

			$('input[type=range]#dice-number').change(function(e){
				$('span#dice-number-visualizer').html( $('input[type=range]#dice-number').val() );
			});

			$('input[type=range]#min-range').change(function(e){
				$('span#min-range-visualizer').html( $('input[type=range]#min-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#max-range').val( $('input[type=range]#min-range').val() );
					$('input[type=range]#max-range').trigger('change');
				}
			});

			$('input[type=range]#max-range').change(function(e){
				$('span#max-range-visualizer').html( $('input[type=range]#max-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#min-range').val( $('input[type=range]#max-range').val() );
					$('input[type=range]#min-range').trigger('change');
				}
			});

			$('input[type=range]#charge-number').change(function(e){
				$('span#charge-number-visualizer').html( $('input[type=range]#charge-number').val() );
			});

			form.submit(function(e){
				e.preventDefault();

				var formData = new FormData();

				$('form#form-main input').each(function(){
					if( $(this).attr('type') == 'text'){
						//console.log($(this).val());
						formData.append( $(this).attr('id') , $(this).val() )
					}
				});

				formData.append('limited', $('form#form-main input[name=limited]:checked').val());

				formData.append('image', $('form#form-main input[type=file]')[0].files[0]);

				formData.append('card-type', $('form#form-main select[name=card-type] option:selected').val());

				if(true){
					formData.append('arc-type', $('form#form-main input[name=arc-type]:checked').val());
					formData.append('dice-number', $('form#form-main input#dice-number').val());
					formData.append('range-bonus', $('form#form-main input[name=range-bonus]:checked').val());
					formData.append('min-range', $('form#form-main input#min-range').val());
					formData.append('max-range', $('form#form-main input#max-range').val());
				}

				formData.append('charge-number', $('form#form-main input[type=range]#charge-number').val());

				formData.append('card-text', $('textarea[name=card-text]').val());

				$.ajax({
					url: 'cardgen.php',
					type: 'POST',
					data: formData,
					success: function (data) {

						cardgenOutput = data;

						if(logOutput){
							console.log(data);
						}

						data = JSON.parse(data);

						var dataUri = data.dataUri;
						$("div#outputImageContainer img").attr('src', dataUri);
						$("div#outputImageContainer a").attr('href', dataUri);
						$("div#outputImageContainer a").attr('download', $('form#form-main input#card-name').val().replace(/ /g,"_"));
						$("div#outputImageContainer a").html('Download');

					},
					cache: false,
					contentType: false,
					processData: false
				});	
			});
		</script>
	</body>
</html>