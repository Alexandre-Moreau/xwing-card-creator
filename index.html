<!DOCTYPE html>
<html>
	<style>
	</style>
	<head>
		<title>Card generator</title>
		<meta charset="UTF-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
		<link rel="stylesheet" href="src/style.css">
	</head>
	<body>
		<div class="row">
			<div class="col s8">
				<form id="form-main">
					<label for="card-name">Card name</label>
					<input type="text" name="card-name">
					<br/>
					<label for="limited">Limited</label>
					<div class="switch">
						<label>No<input type="checkbox" name="limited"><span class="lever"></span>Yes</label>
					</div>
					<br/>
					<div class="input-field col s12">
						<select name="card-type">
							<option value="ept" selected>EPT</option>
							<option value="force">Force</option>
							<option value="astromech">Astromech</option>
							<option value="torpedoes">Torpedoes</option>
							<option value="missiles">Missiles</option>
							<option value="cannon">Cannon</option>
							<option value="turret">Turret</option>
							<option value="device">Device</option>
							<option value="crew">Crew</option>
							<option value="gunner">Gunner</option>
							<option value="system">System</option>
							<option value="illicit">Illicit</option>
							<option value="title">Title</option>
							<option value="modification">Modification</option>
						</select>
						<label for="card-type">Card type</label>
					</div>
					<br/>
					<!--<label for="slots-number">Slots number</label>
					<div class="switch">
						<label>1<input type="checkbox" name="slots-number"><span class="lever"></span>2</label>
					</div>
					<br/>-->

					<label for="card-image">Card image</label>
					<div class="file-field input-field">
						<div class="btn">
							<span>Browse</span>
							<input type="file" />
						</div>

						<div class="file-path-wrapper">
							<input name="card-image" class="file-path validate" type="text" placeholder="Upload file"/>
						</div>
					</div>
					<hr/>
					<div class="row">
						<div class="col s6">
							<label for="limited">Grant attack</label>
							<div class="switch">
								<label>No<input type="checkbox" name="grant-attack"><span class="lever"></span>Yes</label>
							</div>
						</div>
						<div class="input-field col s6">
							<select name="grant-action">
								<option value="none" selected>none</option>
								<!--<option value="calculate">Calculate</option>
								<option value="focus">Focus</option>
								<option value="evade">Evade</option>-->
								<option value="reload">Reload</option>
								<option value="rotate-arc">Rotate arc</option>
								<option value="target-lock">Target Lock</option>
							</select>
							<label for="grant-action">Grant action</label>
						</div>
					</div>
					<hr/>
					<div id="secondary-weapon-stats" hidden>
						<label for="require">Require</label>						
						<div class="inputContainer">
							<label><input type="radio" name="require" value="nothing" checked><span>nothing</span></label>
							<label><input type="radio" name="require" value="target-lock"><span>target lock</span></label>
							<label><input type="radio" name="require" value="focus"><span>focus</span></label>
						</div>
						<label for="arc-type">Firing arc type</label>
						<div class="inputContainer">
							<label><input type="radio" name="arc-type" value="classic" checked><span>classic</span></label>
							<label><input type="radio" name="arc-type" value="rear-classic"><span>rear facing</span></label>
							<label><input type="radio" name="arc-type" value="bullseye"><span>bullseye</span></label>
							<label><input type="radio" name="arc-type" value="rear-bullseye"><span>rear bullseye</span></label>
							<label><input type="radio" name="arc-type" value="single-rotating"><span>single rotating</span></label>
							<label><input type="radio" name="arc-type" value="double-rotating"><span>double rotating</span></label>
						</div>
						<br/>
						<div class="row">
							<div class="col s6">
								<label for="dice-number">Number of dices <span id="dice-number-visualizer" class="badge" title="Number of dices"></span></label>
								<input type="range" id="dice-number" name="min-range" min="1" max="9" value="3"/>
							</div>
							<div class="col s6">
								<label for="range-bonus">Range bonus</label>
								<div class="switch">
									<label>No<input type="checkbox" name="range-bonus"><span class="lever"></span>Yes</label>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col s6">
								<label for="min-range">Minimum range <span id="min-range-visualizer" class="badge" title="Minimum range"></span></label>
								<input type="range" id="min-range" name="min-range" min="0" max="5" value="1"/>
							</div>
							<div class="col s6">
								<label for="max-range">Maximum range <span id="max-range-visualizer" class="badge" title="Maximum range"></span></label>
								<input type="range" id="max-range" name="max-range" min="0" max="5" value="3"/>
							</div>
						</div>
						<hr/>
					</div>
					<div class="row">
						<div class="col s6">
							<label for="charge-number">Charges <span id="charge-number-visualizer" class="badge" title="Charges"></span></label>
							<input type="range" id="charge-number" name="charge-number" min="0" max="9" value="0"/>
						</div>
						<div class="col s6">
							<label for="charge-regenerate">Regenerate</label>
							<div class="switch">
								<label>No<input type="checkbox" name="charge-regenerate"><span class="lever"></span>Yes</label>
							</div>
						</div>
					</div>
					<hr/>
					<label for="card-text">Card text</label>
					<textarea rows="4" cols="50" name="card-text"></textarea>
					<p id="cardTextSymbols"><span symbolText="!boo">!boo (<img src="img/text-boost.png" symbolText="!boo">)</span>, <span symbolText="!cha">!cha (<img src="img/text-charge.png" symbolText="!cha">)</span>, <span symbolText="!crh">!crh (<img src="img/text-criticalHit.png" symbolText="!crh">)</span>, <span symbolText="!dev">!dev (<img src="img/text-device.png" symbolText="!dev">)</span>, <span symbolText="!eva">!eva (<img src="img/text-evade.png" symbolText="!eva">)</span>, <span symbolText="!foc">!foc (<img src="img/text-focus.png" symbolText="!foc">)</span>, <span symbolText="!hit">!hit (<img src="img/text-hit.png" symbolText="!hit">)</span>, <span symbolText="!tlk">!tlk (<img src="img/text-targetLock.png" symbolText="!tlk">)</span></p>
					<hr/>
					Restrictions
					<br/>
					<label for="card-text">Restriction text</label>
					<textarea rows="4" cols="50" name="restrictions-text"></textarea>
					<div id="restrictionsInput">
						<label for="restrictions-faction">Faction</label>
						<div class="inputContainer">
							<label><input type="checkbox" name="restrictions-faction" value="empire" class="filled-in"><span>galactic empire</span></label>
							<label><input type="checkbox" name="restrictions-faction" value="rebel" class="filled-in"><span>rebel alliance</span></label>
							<label><input type="checkbox" name="restrictions-faction" value="scum" class="filled-in"><span>scum and villainy</span></label>
							<label><input type="checkbox" name="restrictions-faction" value="resistance" class="filled-in"><span>resistance</span></label>
							<label><input type="checkbox" name="restrictions-faction" value="first-order" class="filled-in"><span>first order</span></label>
						</div>
						<label for="restrictions-ship-size">Ship size</label>
						<div class="inputContainer">
							<label><input type="checkbox" name="restrictions-ship-size" value="small" class="filled-in"><span>small</span></label>
							<label><input type="checkbox" name="restrictions-ship-size" value="medium" class="filled-in"><span>medium</span></label>
							<label><input type="checkbox" name="restrictions-ship-size" value="large" class="filled-in"><span>large</span></label>
							<label><input type="checkbox" name="restrictions-ship-size" value="huge" class="filled-in"><span>huge</span></label>
						</div>
					</div>
					<div class="btn create">
						<span>Create</span>
					</div>
				</form>
			</div>
			<div class="col s4">
				<div class="btn create">
					<span>Create</span>
				</div>
				<div id="outputImageContainer">
					<img src="">
					<br/>
					<a download="" href=""></a>
				</div>
			</div>
		</div>
		<footer>
			<p>&copy; Alexandre Moreau 2018</p>
			<p><a href="https://github.com/Alexandre-Moreau/xwing-card-creator" target="blank"><img src="img/GitHub-Mark-32px"> Code</a></p>
		</footer>

		<script>
			var form = $("form#form-main");
			var cardgenOutput;
			var logOutput = false;

			$(document).ready(function(){
				$('select').formSelect();
				$('input[type=range]#dice-number').trigger('change');
				$('input[type=range]#min-range').trigger('change');
				$('input[type=range]#max-range').trigger('change');
				$('input[type=range]#charge-number').trigger('change');
			});

			$('div.btn.create').click(function(e){
				form.submit();
			});

			// ----------------------------------- Write symbols on click

			$('p#cardTextSymbols span').click(function(e){

				$('textarea[name=card-text]').val( $('textarea[name=card-text]').val() + $(e.target).attr('symbolText') + ' ' );

			});

			// ----------------------------------- Show or hide secondary weapon div

			$('select[name=card-type], input[type=checkbox][name=grant-attack]').change(function(e){

				var cardType = $('select[name=card-type] option:selected').val();
				var grantAttack = $('input[type=checkbox][name=grant-attack]').prop('checked');

				//$('input[type=checkbox][name=grant-attack]').prop('checked', true);

				$('form#form-main input').prop('disabled', false);

				console.log();

				if(e.target.name == 'card-type'){
					if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){
						$('input[type=checkbox][name=grant-attack]').prop('checked', true);
						$('div#secondary-weapon-stats').show();
					}else{
						$('input[type=checkbox][name=grant-attack]').prop('checked', false);
						$('div#secondary-weapon-stats').hide();
					}
				}else if(e.target.name == 'grant-attack'){
					if(grantAttack == true){
						$('div#secondary-weapon-stats').show();
					}else{
						$('div#secondary-weapon-stats').hide();
					}
				}

				// ------------------------------- Automatically changes "grant action" input

				if(cardType == 'turret'){

					$('select[name=grant-action] option[value=rotate-arc]').prop('selected', true);
					$('select[name=grant-action]').formSelect();

				}else if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon'){

					if($('select[name=grant-action] option:selected').val() == 'rotate-arc' && $('select[name=grant-action] option:selected').val() == 'reload'){
						$('select[name=grant-action] option[value=none]').prop('selected', true);
						$('select[name=grant-action]').formSelect();
					}

				}else if(cardType == 'device'){

					$('select[name=grant-action] option[value=reload]').prop('selected', true);
					$('select[name=grant-action]').formSelect();

				}

				/*
				
				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){

					

					if(cardType == 'torpedoes' || cardType == 'missiles'){
						$('form#form-main input[name=charge-regenerate][value=yes]').prop('disabled', true);
						$('form#form-main input[name=charge-regenerate][value=no]').prop('checked', true);
					}
	
					var selectedArc = $('form#form-main input[name=arc-type]:checked').val();

					if(cardType == 'turret'){
						$('form#form-main input[name=arc-type][value=classic]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=rear-classic]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=bullseye]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=rear-bullseye]').prop('disabled', true);
						if(selectedArc == 'classic' || selectedArc == 'bullseye' || selectedArc == 'rear-classic' || selectedArc == 'rear-bullseye'){
							$('form#form-main input[name=arc-type][value=single-rotating]').prop('checked', true);
						}
					}else if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon'){
						$('form#form-main input[name=arc-type][value=single-rotating]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=double-rotating]').prop('disabled', true);
						if(selectedArc == 'single-rotating' || selectedArc == 'double-rotating'){
							$('form#form-main input[name=arc-type][value=classic]').prop('checked', true);
						}
					}

				}else if(grantAttack == true){

					$('div#secondary-weapon-stats').show();
					$('form#form-main input[name=arc-type][value=classic]').prop('checked', true);

				}else{

					$('div#secondary-weapon-stats').hide();
					$('div#grant-attack').show();
					$('form#form-main input[name=card-text_size][value=large').prop('disabled', false);

				}
				*/
			});

			// ----------------------------------- Create attack text

			$('select[name=card-type], form#form-main input[name=require], form#form-main input[type=range]#charge-number').change(function(e){
				var cardType = $('select[name=card-type] option:selected').val();
				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){
					var oldText = $('textarea[name=card-text]').html();
					var text = '';
					var require = $('form#form-main input[name=require]:checked').val();
					var charges = $('form#form-main input[type=range]#charge-number').val()

					text += 'Attack';
					if(require != 'nothing'){
						if(require == 'target-lock'){
							text += ' (!tlk)';
						}else{
							text += ' (!foc)';
						}
					}
					text += ': ';

					if(charges != '0'){
						text += 'Spend 1 !cha'
					}

					//$('textarea[name=card-text]').val(text);
				}
			});

			// ----------------------------------- Create restrictions text

			$('div#restrictionsInput div label input').change(function(){
				restrictionText = '';				

				$('div#restrictionsInput input[name=restrictions-faction]:checked').each(function(i, e){
					// Last element
					if(i == $('div#restrictionsInput input[name=restrictions-faction]:checked').length-1){
						// If there are restriction on ship size
						if($('div#restrictionsInput input[name=restrictions-ship-size]:checked').length > 0){
							restrictionText += e.value.toUpperCase() + ', ';
						}else{
							restrictionText += e.value.toUpperCase();
						}
					// Not last element
					}else{
						restrictionText += e.value.toUpperCase() + ' OR ';
					}
				});

				$('div#restrictionsInput input[name=restrictions-ship-size]:checked').each(function(i, e){
					if(i == $('div#restrictionsInput input[name=restrictions-ship-size]:checked').length-1){
						restrictionText += e.value.toUpperCase() + ' SHIP';
					}else{
						restrictionText += e.value.toUpperCase() + ' OR ';
					}
				});

				$('form#form-main textarea[name=restrictions-text]').val(restrictionText);

			});

			// ----------------------------------- Visualisers

			$('input[type=range]#dice-number').change(function(e){
				$('span#dice-number-visualizer').html( $('input[type=range]#dice-number').val() );
			});

			$('input[type=range]#min-range').change(function(e){
				$('span#min-range-visualizer').html( $('input[type=range]#min-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#max-range').val( $('input[type=range]#min-range').val() );
					$('input[type=range]#max-range').trigger('change');
				}
			});

			$('input[type=range]#max-range').change(function(e){
				$('span#max-range-visualizer').html( $('input[type=range]#max-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#min-range').val( $('input[type=range]#max-range').val() );
					$('input[type=range]#min-range').trigger('change');
				}
			});

			$('input[type=range]#charge-number').change(function(e){
				$('span#charge-number-visualizer').html( $('input[type=range]#charge-number').val() );
			});

			// ----------------------------------- Form submit

			form.submit(function(e){
				e.preventDefault();

				var formData = new FormData();

				formData.append('card-name', $('form#form-main input[name=card-name]').val());
				formData.append('limited', $('input[type=checkbox][name=limited]').prop('checked'));

				formData.append('image', $('form#form-main input[type=file]')[0].files[0]);

				formData.append('card-type', $('form#form-main select[name=card-type] option:selected').val());

				formData.append('grant-attack', $('form#form-main input[type=checkbox][name=grant-attack]').prop('checked'));

				if(true){
					formData.append('arc-type', $('form#form-main input[name=arc-type]:checked').val());
					formData.append('dice-number', $('form#form-main input#dice-number').val());
					formData.append('range-bonus', $('form#form-main input[type=checkbox][name=range-bonus]').prop('checked'));
					formData.append('min-range', $('form#form-main input#min-range').val());
					formData.append('max-range', $('form#form-main input#max-range').val());
				}

				formData.append('charge-number', $('form#form-main input[type=range]#charge-number').val());
				formData.append('charge-regenerate', $('input[type=checkbox][name=charge-regenerate]').prop('checked'));

				formData.append('card-text', $('form#form-main textarea[name=card-text]').val());

				formData.append('restrictions-text', $('form#form-main textarea[name=restrictions-text]').val());

				$.ajax({
					url: 'cardgen.php',
					type: 'POST',
					data: formData,
					success: function (data) {

						if(logOutput){
							console.log(data);
						}

						data = JSON.parse(data);

						cardgenOutput = data;

						data.log.forEach(function(element) {
						  console.log(element);
						});

						data.errors.forEach(function(element) {
						  console.log('Error: ' + element);
						});

						var dataUri = data.dataUri;
						$("div#outputImageContainer img").attr('src', dataUri);
						$("div#outputImageContainer a").attr('href', dataUri);
						$("div#outputImageContainer a").attr('download', $('form#form-main input[name=card-name]').val().replace(/ /g,"_"));
						$("div#outputImageContainer a").html('Download');

					},
					cache: false,
					contentType: false,
					processData: false
				});	
			});
		</script>
	</body>
</html>