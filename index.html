<!DOCTYPE html>
<html>
	<style>
	</style>
	<head>
		<title>Card generator</title>
		<meta charset="UTF-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
		<link rel="stylesheet" href="src/style.css">
	</head>
	<body>
		<div class="row">
			<div class="col s8">
				<form id="form-main">
					<label for="card-name">Card name</label>
					<input type="text" name="card-name">
					<br/>
					<label for="limited">Limited</label>
					<div class="switch">
						<label>No<input type="checkbox" name="limited"><span class="lever"></span>Yes</label>
					</div>
					<br/>
					<div class="input-field col s12">
						<select name="card-type">
							<option value="ept" selected>EPT</option>
							<option value="force">Force</option>
							<option value="astromech">Astromech</option>
							<option value="torpedoes">Torpedoes</option>
							<option value="missiles">Missiles</option>
							<option value="cannon">Cannon</option>
							<option value="turret">Turret</option>
							<option value="device">Device</option>
							<option value="crew">Crew</option>
							<option value="gunner">Gunner</option>
							<option value="system">System</option>
							<option value="illicit">Illicit</option>
							<option value="title">Title</option>
							<option value="modification">Modification</option>
						</select>
						<label for="card-type">Card type</label>
					</div>
					<br/>
					<label for="slots-number">Slots number</label>
					<div class="switch">
						<label>1<input type="checkbox" name="slots-number"><span class="lever"></span>2</label>
					</div>
					<br/>

					<label for="card-image">Card image</label>
					<div class="file-field input-field">
						<div class="btn">
							<span>Browse</span>
							<input type="file" />
						</div>

						<div class="file-path-wrapper">
							<input name="card-image" class="file-path validate" type="text" placeholder="Upload file"/>
						</div>
					</div>

					<hr/>
					<div id="grant-attack">
						<label for="limited">grant-attack</label>
						<div class="switch">
							<label>No<input type="checkbox" name="grant-attack"><span class="lever"></span>Yes</label>
						</div>
						<hr/>
					</div>
					<div id="secondary-weapon-stats" hidden>
						<label for="require">Require</label>						
						<div class="inputContainer">
							<label><input type="radio" name="require" value="nothing" checked><span>nothing</span></label>
							<label><input type="radio" name="require" value="target-lock"><span>target lock</span></label>
							<label><input type="radio" name="require" value="focus"><span>focus</span></label>
						</div>
						<label for="arc-type">Firing arc type</label>
						<div class="inputContainer">
							<label><input type="radio" name="arc-type" value="classic" checked><span>classic</span></label>
							<label><input type="radio" name="arc-type" value="rear-classic"><span>rear facing</span></label>
							<label><input type="radio" name="arc-type" value="bullseye"><span>bullseye</span></label>
							<label><input type="radio" name="arc-type" value="rear-bullseye"><span>rear bullseye</span></label>
							<label><input type="radio" name="arc-type" value="single-rotating"><span>single rotating</span></label>
							<label><input type="radio" name="arc-type" value="double-rotating"><span>double rotating</span></label>
						</div>
						<br/>
						<div class="row">
							<div class="col s6">
								<label for="dice-number">Number of dices</label>
								<input type="range" id="dice-number" name="min-range" min="1" max="9" value="3"/>
								<span id="dice-number-visualizer"></span>
							</div>
							<div class="col s6">
								<label for="range-bonus">Range bonus</label>
								<div class="switch">
									<label>No<input type="checkbox" name="range-bonus"><span class="lever"></span>Yes</label>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col s6">
								<label for="min-range">Minimum range</label>
								<input type="range" id="min-range" name="min-range" min="0" max="5" value="1"/>
								<span id="min-range-visualizer"></span>
							</div>
							<div class="col s6">
								<label for="max-range">Maximum range</label>
								<input type="range" id="max-range" name="max-range" min="0" max="5" value="3"/>
								<span id="max-range-visualizer"></span>
							</div>
						</div>
						<hr/>
					</div>
					<label for="charge-number">Charges</label>
					<input type="range" id="charge-number" name="charge-number" min="0" max="9" value="0"/>
					<span id="charge-number-visualizer"></span>
					<br/>
					<label for="regenerate">Regenerate</label>
						<div class="switch">
							<label>No<input type="checkbox" name="regenerate"><span class="lever"></span>Yes</label>
						</div>
					<hr/>
					<!--
						!boo		boost
						!cha		charge
						!crh		critical hit
						!evd		evade
						!foc		focus
						!hit		hit
						!rei		reinforce
						!tlk		target lock
					-->
					<label for="card-text">Card text</label>
					<textarea rows="4" cols="50" name="card-text"></textarea>
					<p>!boo (boost), !cha (charge), !crh (critical hit), !eva (evade), !foc (focus), !hit (hit), !rei (reinforce), !tlk (target lock)</p>
					<hr/>
					Restrictions
					<br/>
					<label for="restrictions-ship-size">Ship size</label>
					<div class="inputContainer">
						<label><input type="checkbox" name="restrictions-ship-size" value="small" class="filled-in"><span>small</span></label>
						<label><input type="checkbox" name="restrictions-ship-size" value="medium" class="filled-in"><span>medium</span></label>
						<label><input type="checkbox" name="restrictions-ship-size" value="large" class="filled-in"><span>large</span></label>
						<label><input type="checkbox" name="restrictions-ship-size" value="huge" class="filled-in"><span>huge</span></label>
					</div>
					<label for="restrictions-faction">Faction</label>
					<div class="inputContainer">
						<label><input type="checkbox" name="restrictions-faction" value="empire" class="filled-in"><span>galactic empire</span></label>
						<label><input type="checkbox" name="restrictions-faction" value="rebels" class="filled-in"><span>rebel alliance</span></label>
						<label><input type="checkbox" name="restrictions-faction" value="scums" class="filled-in"><span>scum and villainy</span></label>
						<label><input type="checkbox" name="restrictions-faction" value="resistance" class="filled-in"><span>resistance</span></label>
						<label><input type="checkbox" name="restrictions-faction" value="first-order" class="filled-in"><span>first order</span></label>
					</div>
					<hr/>
				</form>
			</div>
			<div class="col s4">
				<input type="submit" value="Create">
				<div id="outputImageContainer">
					<img src="">
					<br/>
					<a download="" href=""></a>
				</div>
			</div>
		</div>
		<footer>
			<p>&copy; Alexandre Moreau 2018</p>
			<p><a href="https://github.com/Alexandre-Moreau/xwing-card-creator" target="blank"><img src="img/GitHub-Mark-32px"> Code</a></p>
		</footer>

		<script>
			var form = $("form#form-main");
			var cardgenOutput;
			var logOutput = false;

			$(document).ready(function(){
				$('select').formSelect();
				$('input[type=range]#dice-number').trigger('change');
				$('input[type=range]#min-range').trigger('change');
				$('input[type=range]#max-range').trigger('change');
				$('input[type=range]#charge-number').trigger('change');
			});

			$('input[type=submit]').click(function(e){
				form.submit();
			});

			// ----------------------------------- Show or hide secondary weapon div

			$('select[name=card-type], input[name=grant-attack]').change(function(e){

				var cardType = $('select[name=card-type] option:selected').val();
				var grantAttack = $('form#form-main input[name=grant-attack]:checked').val();

				$('form#form-main input').prop('disabled', false);

				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){

					$('div#secondary-weapon-stats').show();
					$('div#grant-attack').hide();

					if(cardType == 'torpedoes' || cardType == 'missiles'){
						$('form#form-main input[name=charge-regenerate][value=yes]').prop('disabled', true);
						$('form#form-main input[name=charge-regenerate][value=no]').prop('checked', true);
					}
	
					var selectedArc = $('form#form-main input[name=arc-type]:checked').val();

					if(cardType == 'turret'){
						$('form#form-main input[name=arc-type][value=classic]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=rear-classic]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=bullseye]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=rear-bullseye]').prop('disabled', true);
						if(selectedArc == 'classic' || selectedArc == 'bullseye' || selectedArc == 'rear-classic' || selectedArc == 'rear-bullseye'){
							$('form#form-main input[name=arc-type][value=single-rotating]').prop('checked', true);
						}
					}else if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon'){
						$('form#form-main input[name=arc-type][value=single-rotating]').prop('disabled', true);
						$('form#form-main input[name=arc-type][value=double-rotating]').prop('disabled', true);
						if(selectedArc == 'single-rotating' || selectedArc == 'double-rotating'){
							$('form#form-main input[name=arc-type][value=classic]').prop('checked', true);
						}
					}

				}else if(grantAttack == 'yes'){

					$('div#secondary-weapon-stats').show();
					$('form#form-main input[name=arc-type][value=classic]').prop('checked', true);

				}else{

					$('div#secondary-weapon-stats').hide();
					$('div#grant-attack').show();
					$('form#form-main input[name=card-text_size][value=large').prop('disabled', false);

				}
			});

			// ----------------------------------- Create attack text

			$('select[name=card-type], form#form-main input[name=require], form#form-main input[type=range]#charge-number').change(function(e){
				var cardType = $('select[name=card-type] option:selected').val();
				if(cardType == 'torpedoes' || cardType == 'missiles' || cardType == 'cannon' || cardType == 'turret'){
					var oldText = $('textarea[name=card-text]').html();
					var text = '';
					var require = $('form#form-main input[name=require]:checked').val();
					var charges = $('form#form-main input[type=range]#charge-number').val()

					text += 'Attack';
					if(require != 'nothing'){
						if(require == 'target-lock'){
							text += ' (!tlk)';
						}else{
							text += ' (!foc)';
						}
					}
					text += ': ';

					if(charges != '0'){
						text += 'Spend 1 !ch.'
					}

					$('textarea[name=card-text]').val(text);
				}
			});

			// ----------------------------------- Visualisers

			$('input[type=range]#dice-number').change(function(e){
				$('span#dice-number-visualizer').html( $('input[type=range]#dice-number').val() );
			});

			$('input[type=range]#min-range').change(function(e){
				$('span#min-range-visualizer').html( $('input[type=range]#min-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#max-range').val( $('input[type=range]#min-range').val() );
					$('input[type=range]#max-range').trigger('change');
				}
			});

			$('input[type=range]#max-range').change(function(e){
				$('span#max-range-visualizer').html( $('input[type=range]#max-range').val() );
				if( $('input[type=range]#min-range').val() > $('input[type=range]#max-range').val() ){
					$('input[type=range]#min-range').val( $('input[type=range]#max-range').val() );
					$('input[type=range]#min-range').trigger('change');
				}
			});

			$('input[type=range]#charge-number').change(function(e){
				$('span#charge-number-visualizer').html( $('input[type=range]#charge-number').val() );
			});

			// ----------------------------------- Form submit

			form.submit(function(e){
				e.preventDefault();

				var formData = new FormData();

				formData.append('card-name', $('form#form-main input[name=card-name]').val());

				formData.append('limited', $('input[type=checkbox][name=limited]').prop('checked'));

				formData.append('image', $('form#form-main input[type=file]')[0].files[0]);

				formData.append('card-type', $('form#form-main select[name=card-type] option:selected').val());

				if(true){
					formData.append('arc-type', $('form#form-main input[name=arc-type]:checked').val());
					formData.append('dice-number', $('form#form-main input#dice-number').val());
					formData.append('range-bonus', $('form#form-main input[name=range-bonus]:checked').val());
					formData.append('min-range', $('form#form-main input#min-range').val());
					formData.append('max-range', $('form#form-main input#max-range').val());
				}

				formData.append('charge-number', $('form#form-main input[type=range]#charge-number').val());

				formData.append('card-text', $('textarea[name=card-text]').val());

				$.ajax({
					url: 'cardgen.php',
					type: 'POST',
					data: formData,
					success: function (data) {

						cardgenOutput = data;

						if(logOutput){
							console.log(data);
						}

						data = JSON.parse(data);

						data.log.forEach(function(element) {
						  console.log(element);
						});

						data.errors.forEach(function(element) {
						  console.log('Error: ' + element);
						});

						var dataUri = data.dataUri;
						$("div#outputImageContainer img").attr('src', dataUri);
						$("div#outputImageContainer a").attr('href', dataUri);
						$("div#outputImageContainer a").attr('download', $('form#form-main input[name=card-name]').val().replace(/ /g,"_"));
						$("div#outputImageContainer a").html('Download');

					},
					cache: false,
					contentType: false,
					processData: false
				});	
			});
		</script>
	</body>
</html>